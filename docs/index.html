<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script>
    let data = fetch("main.bin");
  </script>
</head>
<body>
  <pre id="log"></pre>
  <script>
    function Exit(ec) {
      this.ec = ec;
    }

    function print(str, style) {
      let span = document.createElement("span");
      let log = document.getElementById("log");
      if (typeof style === "string") {
        console.log("%c" + str, style);
        span.style = style;
      } else {
        console.log(str);
      }
      span.innerText = str;
      log.appendChild(span);
      log.appendChild(document.createElement("br"));
    }

    const page_size = (64 * 1024);

    const heap = {
      data: null,
      memory: null,
      uint8: null,
      uint32: null,
      size: 16 * 1024 * 1024,
      end: 0,
      set: (memory) => {
        heap.memory = memory;
        heap.data = heap.memory.buffer
        heap.uint8 = new Uint8Array(heap.data);
        heap.uint32 = new Uint32Array(heap.data);
        heap.size = heap.data.byteLength;
      },
      char: (ptr) => {
        return String.fromCharCode(heap.uint8[ptr]);
      },
      string: (ptr, len = -1) => {
        let str = "";
        let end = len > -1 ? ptr + len : heap.size;
        for (let i = ptr; i < end && heap.uint8[i] !== 0; ++i) {
          let c = heap.char(i);
          if (c !== '\r') {
            str += c;
          }
        }
        return str;
      }
    };

    heap.set(new WebAssembly.Memory({
      initial: heap.size / page_size,
      maximum: heap.size / page_size
    }));

    const sys = {
      /* restart_syscall */ 1: () => {
        throw new Error("rs");
      },
      /* brk */ 45: (addr) => {
        if (addr > heap.size) {
          heap.memory.grow(Math.ceil((addr - heap.size) / page_size));
          heap.set(heap.memory);
        }
        if (addr != 0) {
          heap.end = addr;
        }
        return heap.end;
      },
      /* ioctl */ 54: () => {
        return -1;
      },
      /* writev */ 146: (fd, iov, iovcnt) => {
        let ret = 0;
        let str = "";
        let iov32 = iov / 4;
        for (let i = 0; i < iovcnt; i++) {
          let ptr = heap.uint32[iov32++];
          let len = heap.uint32[iov32++];
          if (len > 0) {
            str += heap.string(ptr, len);
            ret += len;
          }
        }
        if (str.length > 0 && str[str.length - 1] === '\n') {
          str = str.slice(0, str.length - 1);
        }
        print(str, fd === 2 ? "color: #d33;" : null);
        return ret;
      },
      /* exit_group */ 252: (ec) => {
        throw new Exit(ec);
      }
    };

    const syscall = (n, a, b, c, d, e, f) => {
      if (n in sys) {
        return sys[n](a, b, c, d, e, f);
      }
      console.log("syscall:", n, a, b, c, d, e, f);
      return -1;
    };

    async function main() {
      try {
        let wasm = await data;
        let init = await WebAssembly.instantiate(await wasm.arrayBuffer(), {
          env: {
            memory: heap.memory,
            __syscall: syscall,
            __syscall0: syscall,
            __syscall1: syscall,
            __syscall2: syscall,
            __syscall3: syscall,
            __syscall4: syscall,
            __syscall5: syscall,
            __syscall6: syscall,
            __syscall_cp: syscall,
            test: () => {
              return 2;
            },
            "_ZN3ice4testEv": () => {
              return 3;
            }
          }
        });
        delete wasm; wasm = null;
        delete data; data = null;
        heap.set(init.instance.exports.memory);
        heap.end = init.instance.exports.__heap_base;
        init.instance.exports._start();
      }
      catch (e) {
        if (e instanceof Exit) {
          print("exit: " + e.ec, "color: #888; font-weight: bold;");
        } else {
          throw e;
        }
      }
    }
    main();
  </script>
</body>
</html>
